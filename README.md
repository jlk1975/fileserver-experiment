# fileserver-experiment

## Setup

- East Coast
  - Laptop/Workstation
    - Sign up for Linode account at linode.com
    - Obtain a personal access token for Linode’s v4 API to use with Terraform
    - Install Terraform (Laptop)
      - ```mkdir ~terraform```
      - ```cd ~terraform```
      - ```wget https://releases.hashicorp.com/terraform/1.3.4/terraform_1.3.4_linux_amd64.zip```
      - ```wget https://releases.hashicorp.com/terraform/1.3.4/terraform_1.3.4_SHA256SUMS```
      - ```wget https://releases.hashicorp.com/terraform/1.3.4/terraform_1.3.4_SHA256SUMS.sig```
      - Download the GPG public key, the file you want to verify, and its corresponding signature file. 
      - Name the key hashicorp.asc. 
      - Navigate to the directory where you saved hashicorp.asc and run the following command:
        - ```gpg --import hashicorp.asc```
      - Verify the key against the fingerprint for the key:
        - ```gpg --fingerprint C874011F0AB405110D02105534365D9472D7468F```
      - Make sure you don't see an error like this:
        - ```gpg: error reading key: No public key```
      - Verify the signature:
        - ```gpg --verify terraform_1.3.4_SHA256SUMS.sig terraform_1.3.4_SHA256SUMS```
      - You want to see "gpg: Good signature from "HashiCorp Security (hashicorp.com/security) <security@hashicorp.com>" [unknown]"
      - Warning such as "gpg: WARNING: This key is not certified with a trusted signature!" can probably be ignored. 
    - Verify the .zip archive’s checksum:
      - ```sha256sum -c terraform*SHA256SUMS 2>&1 | grep OK```
    - You want to see output that looks like this: "sha256sum -c terraform*SHA256SUMS 2>&1 | grep OK"
    - Configure Terraform
      - ```unzip terraform_*_linux_amd64.zip```
      - ```echo 'export PATH="$PATH:$HOME/terraform"' >> ~/.profile```
      - ```source ~/.profile```
      - Verify terraform can run by running:
      - ```terraform```
      - Create a .gitignore file with terraform stuff to ignore (example included in this git repo.)
      - Create a secret.tfvars file and add your Linode API key into it
      - Create a linode-control-server.tf file (or use the one in this github repo in the terraform directory.)
      - cd ~/terraform or cd terraform (into your github checkout of this repo if you prefer)
      - ```terraform init```
      - ```terraform plan -var-file="secret.tfvars"```
      - ```terraform apply -var-file="secret.tfvars"```
      - 
    -Prometheus Stuff
      - Plain ol Prometheus: 
        - https://prometheus.io/docs/prometheus/latest/getting_started/
        - ```wget https://github.com/prometheus/prometheus/releases/download/v2.40.1/prometheus-2.40.1.linux-amd64.tar.gz```
        - ```tar xvfz prometheus-*.tar.gz```
        - ```cd prometheus-*```
        - Prometheus collects metrics from targets by scraping metrics HTTP endpoints. Since Prometheus exposes data in the same manner about itself, it can also scrape and monitor its own health.
        - ```cp ./prometheus/prometheus.yaml ~/directory_you_untarred_prometheus_binary_into```
        - To start Prometheus with your newly created configuration file, change to the directory containing the Prometheus binary and run:
        - ```# Start Prometheus.```
        - ```# By default, Prometheus stores its database in ./data (flag --storage.tsdb.path).```
        - ```cd ~/directory_you_untarred_prometheus_binary_into```
        - ```./prometheus --config.file=prometheus.yml```
        - Point your web browser to http://localhost:9090/
        - Prometheus should be running now!
        - Go to http://localhost:9090/graph
        - Query Examples:
        - prometheus_target_interval_length_seconds
        - prometheus_target_interval_length_seconds{quantile="0.99"}
        - To count the number of returned time series, you could write:
        - count(prometheus_target_interval_length_seconds)
        - To graph expressions, navigate to http://localhost:9090/graph and use the "Graph" tab.
        - For example, enter the following expression to graph the per-second rate of chunks being created in the self-scraped Prometheus:
        - rate(prometheus_tsdb_head_chunks_created_total[1m])
        - More things to do with Prometheus can be found here:
          - https://prometheus.io/docs/prometheus/latest/getting_started/
        - MONITORING LINUX HOST METRICS WITH THE NODE EXPORTER (how to tie into grafana?)
          - https://prometheus.io/docs/guides/node-exporter/
          - Start up a Node Exporter on localhost
          - Start up a Prometheus instance on localhost that's configured to scrape metrics from the running Node Exporter
          - The Prometheus Node Exporter is a single static binary that you can install via tarball. Once you've downloaded it from the Prometheus downloads page extract it, and run it:
          - ```wget https://github.com/prometheus/node_exporter/releases/download/v*/node_exporter-*.*-amd64.tar.gz```
          - ```tar xvfz node_exporter-*.*-amd64.tar.gz```
          - ```cd node_exporter-*.*-amd64```
          - ```./node_exporter```
        

      - Prometheus node_exporter: 
        - https://prometheus.io/download/#node_exporter
      - Prometheus node_exporter installed using Ansible:
        - https://github.com/cloudalchemy/ansible-node-exporter
      - Prometheus Alert Manager
        - https://prometheus.io/download/#alertmanager 
    -Install Ansible (Laptop)
      - next steps, install the linode cli, then
      - login to your new file server instance and get a golang file server
      - running manually , just prove out that you can upload/download files over HTTP
      - from/to your laptop using curl. 
      - use this great article: https://medium.com/rungo/beginners-guide-to-serving-files-using-http-servers-in-go-4e542e628eac
      - after that, provision a client server 
      - and do the same thing. 
      - tbd
    - Splunk Stuff?



    

  - Linode Servers
    - Control Server 
      - Let's not install Terraform here, just use it on laptop/workstation for now.
      - Let's not install Ansible here, just use it on laptop/workstation for now.
      - Git
      - Grafana Dashboard
      - JMeter?  
      - Siege?
    - File Server
      - File system
      - Golang file server code
    - CDN Server 1
      - VarnishCDN Opensource Software
    - Client Server 1 (This is an end client that needs to download files)
      - Can be configured to download from origin file server, or CDN
      - wget?
      - curl?
      - Apache JMeter?
      - Siege?
      - Prometheus to gather file usage stats
- West Coast
  - Client Server 2 (This is an end client that needs to download files)
    - Can be configured to download from origin file server, or CDN.
    - wget?
    - curl?
    - Apache JMeter?
    - Siege?
    - Prometheus to gather file usage stats